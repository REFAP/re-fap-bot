<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Re-FAP assistant</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,sans-serif;margin:24px;background:#fafafa;color:#111}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:20px;max-width:980px;margin:0 auto}
    .bot{color:#059669;margin-bottom:12px}
    .me{color:#111;margin:8px 0 16px}
    textarea{width:100%;padding:14px;border:1px solid #d1d5db;border-radius:12px;font-size:16px}
    button{padding:10px 16px;border:1px solid #111;border-radius:10px;background:#111;color:#fff;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    pre{white-space:pre-wrap;word-wrap:break-word}
    .hint{color:#6b7280;margin-top:10px;font-size:12px}
    .err{color:#b91c1c;white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="card">
    <div class="bot">Bot: Salut ! Décris ton symptôme et je t’aide à diagnostiquer.</div>
    <div id="log" class="me"></div>
    <pre id="output"></pre>

    <form id="f" style="margin-top:16px">
      <textarea id="q" rows="3" placeholder="Décris le symptôme..."></textarea>
      <div style="display:flex;gap:10px;align-items:center;margin-top:10px">
        <button id="send" type="submit">Envoyer</button>
        <span id="state" class="hint"></span>
      </div>
    </form>

    <div class="hint">
      Streaming via <code>/api/diagnose/stream</code> (GET SSE).
      Si le streaming n’est pas dispo, on bascule automatiquement en réponse non-stream (<code>/api/diagnose</code>).
    </div>
  </div>

  <script>
  const out = document.getElementById("output");
  const log = document.getElementById("log");
  const state = document.getElementById("state");
  const form = document.getElementById("f");
  const q = document.getElementById("q");
  const btn = document.getElementById("send");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const prompt = q.value.trim();
    if (!prompt) return;
    out.textContent = "";
    log.textContent = "Toi: " + prompt;
    btn.disabled = true;
    state.textContent = "…";

    try {
      await diagnose(prompt);
    } catch (err) {
      out.innerHTML = `<span class="err">Erreur: ${err?.message || err}</span>`;
    } finally {
      btn.disabled = false;
      state.textContent = "";
    }
  });

  async function diagnose(prompt) {
    // 1) Essai streaming SSE (GET avec ?prompt=...)
    const url = `/api/diagnose/stream?prompt=${encodeURIComponent(prompt)}`;
    try {
      await new Promise((resolve, reject) => {
        const es = new EventSource(url);
        es.onmessage = (e) => {
          // Le serveur envoie {delta: "..."} ou du texte brut; gérons les deux.
          try {
            const o = JSON.parse(e.data);
            if (o.delta) out.textContent += o.delta;
            else if (o.error) { es.close(); reject(new Error(o.error)); }
            else if (typeof o === "string") out.textContent += o;
          } catch {
            out.textContent += e.data;
          }
        };
        es.addEventListener("done", () => { es.close(); resolve(); });
        es.onerror = () => { es.close(); reject(new Error("sse_error")); };
      });
      return;
    } catch (_) {
      // 2) Fallback non-stream propre: POST sur /api/diagnose (plus /api/admin/rag/diagnose)
      const r = await fetch("/api/diagnose", {
        method: "POST",
        headers: { "Content-Type": "text/plain; charset=utf-8" },
        body: prompt
      });
      if (!r.ok) {
        const txt = await r.text();
        throw new Error(`HTTP ${r.status}: ${txt}`);
      }
      const ct = r.headers.get("content-type") || "";
      if (ct.includes("application/json")) {
        const j = await r.json();
        out.textContent = j.text || JSON.stringify(j);
      } else {
        out.textContent = await r.text();
      }
    }
  }
  </script>
</body>
</html>
