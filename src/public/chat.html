<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Re-FAP assistant</title>
  <style>
    :root{--fg:#111;--muted:#6b7280;--border:#e5e7eb;--bg:#fafafa;--brand:#111;--accent:#0b5}
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Roboto,sans-serif;margin:24px;background:var(--bg);color:var(--fg)}
    .wrap{max-width:980px;margin:0 auto}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:20px}
    h2{margin:0 0 6px 0}
    textarea,input{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px;font-size:16px}
    button{padding:10px 16px;border:1px solid var(--brand);border-radius:10px;background:var(--brand);color:#fff;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    pre{white-space:pre-wrap;word-wrap:break-word;margin:8px 0 0}
    .row{display:flex;gap:10px}
    .col{flex:1}
    .hint{color:var(--muted);font-size:12px}
    .cta{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .btn-outline{background:#fff;color:var(--fg)}
    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:16px;z-index:20}
    .modal.open{display:flex}
    .modal .box{background:#fff;border-radius:12px;padding:20px;max-width:560px;width:100%;border:1px solid var(--border)}
    .modal h3{margin-top:0}
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Re-FAP assistant</h2>
      <div id="log" class="hint"></div>
      <pre id="output"></pre>
      <div id="ctas" class="cta"></div>

      <form id="f" style="margin-top:16px">
        <textarea id="q" rows="3" placeholder="Décris le symptôme..."></textarea>
        <div class="row" style="margin-top:10px;align-items:center">
          <div class="col"><span id="state" class="hint"></span></div>
          <button id="send" type="submit">Envoyer</button>
        </div>
      </form>
      <div class="hint" style="margin-top:6px">
        Le texte arrive en streaming. Les boutons (CTA) apparaissent ensuite.
      </div>
    </div>
  </div>

  <!-- Modal 1: Infos véhicule -->
  <div class="modal" id="modalIntake">
    <div class="box">
      <h3>Quelques infos (optionnel)</h3>
      <div class="row"><div class="col"><input id="brand"  placeholder="Marque"></div><div class="col"><input id="model" placeholder="Modèle"></div></div>
      <div class="row" style="margin-top:8px"><div class="col"><input id="engine" placeholder="Moteur (ex: 1.6 HDi)"></div><div class="col"><input id="year" placeholder="Année-modèle (ex: 2015)"></div></div>
      <div class="row" style="margin-top:8px"><div class="col"><input id="dtc" placeholder="Code erreur OBD (DTC) si connu"></div><div class="col"><input id="postal" placeholder="Code postal"></div></div>
      <div style="margin-top:8px"><textarea id="notes" rows="2" placeholder="Observations (facultatif)"></textarea></div>
      <div class="actions">
        <button type="button" id="skipIntake" class="btn-outline">Ignorer</button>
        <button type="button" id="saveIntake">Enregistrer</button>
      </div>
      <div class="hint">Ces infos nous aident à affiner le diagnostic et à te proposer un garage proche. Tu peux ignorer.</div>
    </div>
  </div>

  <!-- Modal 2: Être rappelé -->
  <div class="modal" id="modalCallback">
    <div class="box">
      <h3>Être rappelé par un conseiller</h3>
      <div class="row"><div class="col"><input id="cbName" placeholder="Nom"></div><div class="col"><input id="cbPhone" placeholder="Téléphone"></div></div>
      <div class="row" style="margin-top:8px"><div class="col"><input id="cbEmail" placeholder="Email"></div></div>
      <div class="actions">
        <button type="button" id="cancelCb" class="btn-outline">Annuler</button>
        <button type="button" id="saveCb">Envoyer</button>
      </div>
      <div class="hint">On t’appelle rapidement pour caler un rendez-vous avec un garage partenaire sérieux.</div>
    </div>
  </div>

  <script>
  const out   = document.getElementById("output");
  const log   = document.getElementById("log");
  const state = document.getElementById("state");
  const form  = document.getElementById("f");
  const q     = document.getElementById("q");
  const btn   = document.getElementById("send");
  const ctas  = document.getElementById("ctas");

  // modals
  const modalIntake = document.getElementById("modalIntake");
  const modalCallback = document.getElementById("modalCallback");

  // session id simple (localStorage)
  const SID_KEY = "refap_sid";
  let sid = localStorage.getItem(SID_KEY);
  if (!sid) { sid = Math.random().toString(36).slice(2); localStorage.setItem(SID_KEY, sid); }

  function openModal(m){ m.classList.add("open"); }
  function closeModal(m){ m.classList.remove("open"); }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const prompt = q.value.trim();
    if (!prompt) return;
    out.textContent = "";
    ctas.innerHTML  = "";
    log.textContent = "Toi: " + prompt;
    btn.disabled = true; state.textContent = "…";

    // 1) ouvrir la modal intake (optionnelle)
    openModal(modalIntake);

    const doAfterIntake = async () => {
      try {
        // 2) streaming pour le texte (UX fluide)
        await streamAnswer(prompt);
      } catch (err) {
        out.textContent = "Erreur: " + (err?.message || err);
      } finally {
        btn.disabled = false; state.textContent = "";
      }

      // 3) en parallèle: appel non-stream pour récupérer payload (CTA)
      try {
        const r = await fetch(`/api/diagnose?prompt=${encodeURIComponent(prompt)}`);
        if (r.ok) {
          const j = await r.json();
          renderCTAs(j?.payload);
        }
      } catch {}
    };

    // handlers modal intake
    document.getElementById("skipIntake").onclick = () => { closeModal(modalIntake); doAfterIntake(); };
    document.getElementById("saveIntake").onclick = async () => {
      const body = {
        session_id: sid,
        brand:  document.getElementById("brand").value.trim() || null,
        model:  document.getElementById("model").value.trim() || null,
        engine: document.getElementById("engine").value.trim() || null,
        year:   document.getElementById("year").value.trim() || null,
        dtc:    document.getElementById("dtc").value.trim() || null,
        notes:  document.getElementById("notes").value.trim() || null,
        postal_code: document.getElementById("postal").value.trim() || null
      };
      try {
        await fetch("/api/leads/intake", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
      } catch {}
      closeModal(modalIntake);
      doAfterIntake();
    };
  });

  // --- SSE robuste : close sur {done:true}, tolère onerror si du texte a été reçu
  async function streamAnswer(prompt) {
    const url = `/api/diagnose/stream?prompt=${encodeURIComponent(prompt)}`;
    let received = false;
    await new Promise((resolve, reject) => {
      const es = new EventSource(url);

      es.onmessage = (e) => {
        try {
          const o = JSON.parse(e.data);
          if (o.error) { es.close(); reject(new Error(o.error)); return; }
          if (o.delta) { out.textContent += o.delta; received = true; }
          if (o.done)  { es.close(); resolve(); }
        } catch {
          out.textContent += e.data;
          if (e.data && e.data.length) received = true;
        }
      };

      es.onerror = () => {
        es.close();
        if (received) resolve();   // fermeture propre tolérée
        else reject(new Error("sse_error"));
      };
    });
  }

  function renderCTAs(payload){
    if (payload?.cta?.show && Array.isArray(payload.cta.items)) {
  for (const item of payload.cta.items.slice(0,2)) {
    const b = document.createElement("button");
    b.textContent = item.label || "Action";
    b.className = "btn-outline";
    b.onclick = () => { if (item.url) window.location.href = item.url; };
    ctas.appendChild(b);
  }
}

if (!payload) return;
    ctas.innerHTML = "";

    // CTA proposés par le serveur / modèle
    if (payload?.cta?.show && Array.isArray(payload.cta.items)) {
      for (const item of payload.cta.items.slice(0,2)) {
        const b = document.createElement("button");
        b.textContent = item.label || "Action";
        b.className = "btn-outline";
        b.onclick = () => { if (item.url) window.location.href = item.url; };
        ctas.appendChild(b);
      }
    }

    // bouton Être rappelé (toujours dispo)
    const callBtn = document.createElement("button");
    callBtn.textContent = "Être rappelé";
    callBtn.style.background = "var(--accent)";
    callBtn.style.borderColor = "var(--accent)";
    callBtn.onclick = () => openModal(modalCallback);
    ctas.appendChild(callBtn);

    // handlers callback modal
    document.getElementById("cancelCb").onclick = () => closeModal(modalCallback);
    document.getElementById("saveCb").onclick = async () => {
      const body = {
        session_id: sid,
        contact_name:  document.getElementById("cbName").value.trim() || null,
        contact_phone: document.getElementById("cbPhone").value.trim() || null,
        contact_email: document.getElementById("cbEmail").value.trim() || null
      };
      try {
        await fetch("/api/leads/callback", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        closeModal(modalCallback);
        alert("Merci ! On te rappelle rapidement.");
      } catch {
        alert("Désolé, l’enregistrement a échoué.");
      }
    };
  }
  </script>
</body>
</html>
