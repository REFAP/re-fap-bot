<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Re-FAP assistant</title>
  <style>
    /* ========= Thème ========= */
    :root{
      --fg:#0f172a;           /* slate-900 */
      --muted:#64748b;        /* slate-500 */
      --border:#e2e8f0;       /* slate-200 */
      --bg:#f8fafc;           /* slate-50 */
      --card:#ffffff;
      --brand:#111827;        /* gray-900 */
      --accent:#0bb37b;       /* vert */
      --accent-ghost:#e9fbf4;
      --shadow: 0 10px 20px rgba(2,6,23,.08);
      --radius:16px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 800px at 85% -10%, #d1fae5 0%, rgba(209,250,229,0) 55%),
        radial-gradient(900px 600px at -10% 10%, #e0f2fe 0%, rgba(224,242,254,0) 45%),
        var(--bg);
      color:var(--fg);
      font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      padding:24px;
    }

    /* ========= Grille ========= */
    .wrap{max-width:980px;margin:0 auto}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:24px;
      box-shadow: var(--shadow);
      backdrop-filter: saturate(130%) blur(2px);
    }

    /* ========= Titre / header ========= */
    .header{
      display:flex; align-items:center; gap:12px; margin-bottom:10px;
    }
    .logo{
      display:inline-grid; place-items:center;
      width:42px;height:42px;border-radius:12px;
      background:linear-gradient(135deg,#10b981, #0ea5e9);
      color:#fff; font-weight:800; letter-spacing:.5px;
      box-shadow: 0 8px 20px rgba(16,185,129,.25);
    }
    h2{margin:0;font-size:22px}
    .sub{color:var(--muted);font-size:13px;margin-top:2px}

    /* ========= Zone sortie ========= */
    pre{
      white-space:pre-wrap; word-wrap:break-word; margin:12px 0 10px;
      padding:14px 16px; border:1px solid var(--border); border-radius:12px; background:#fff;
      min-height:60px;
    }

    /* ========= Formulaire ========= */
    textarea,input{
      width:100%; padding:12px 14px; border:1px solid var(--border);
      border-radius:12px; font-size:16px; background:#fff;
    }
    .row{display:flex;gap:10px}
    .col{flex:1}
    .hint{color:var(--muted);font-size:12px}

    /* ========= Boutons ========= */
    button,.btn{
      padding:11px 16px; border-radius:12px; border:1px solid var(--brand);
      background:var(--brand); color:#fff; cursor:pointer; font-weight:600;
      box-shadow: 0 6px 14px rgba(2,6,23,.08);
    }
    button:disabled{opacity:.6;cursor:not-allowed;filter:grayscale(.1)}
    .btn-outline{background:#fff;color:var(--fg);border-color:#cbd5e1}
    .btn-ghost{background:var(--accent-ghost); color:#0b7; border-color:transparent}
    .btn-accent{background:var(--accent); border-color:var(--accent)}
    .btn-link{background:transparent;border-color:transparent;color:var(--fg);padding:0}

    /* ========= CTA dynamiques ========= */
    .cta{display:flex;gap:12px;margin-top:14px;flex-wrap:wrap}
    .cta > button, .cta > a{min-width:220px}

    /* ========= Questions ========= */
    .questions{margin:10px 0 0 0;padding-left:20px}
    .questions li{margin:5px 0}
    .ask{color:#059669;font-weight:800}
    .qtitle{color:#065f46;font-weight:800;margin:14px 0 6px}

    /* ========= État (en cours) ========= */
    .status{
      display:inline-flex;align-items:center;gap:8px;font-size:13px;color:var(--muted)
    }
    .dot{width:10px;height:10px;border-radius:50%;background:#cbd5e1}
    .dot.live{background:#22c55e; box-shadow:0 0 0 0 rgba(34,197,94,.7); animation:pulse 1.6s infinite}
    @keyframes pulse {
      0%{box-shadow:0 0 0 0 rgba(34,197,94,.6)}
      70%{box-shadow:0 0 0 16px rgba(34,197,94,0)}
      100%{box-shadow:0 0 0 0 rgba(34,197,94,0)}
    }

    /* ========= Modales ========= */
    .modal{position:fixed;inset:0;background:rgba(2,6,23,.35);display:none;align-items:center;justify-content:center;padding:16px;z-index:20}
    .modal.open{display:flex}
    .modal .box{background:#fff;border-radius:16px;padding:20px;max-width:560px;width:100%;border:1px solid var(--border);box-shadow:var(--shadow)}
    .modal h3{margin-top:0}
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}

    /* ========= Barre d’actions sticky ========= */
    .sticky-wrap{
      position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
      width:min(980px, calc(100% - 24px*2));
      z-index:15;
    }
    .stickybar{
      display:flex;justify-content:space-between;align-items:center;gap:16px;
      background:#ffffffcc;border:1px solid var(--border);backdrop-filter: blur(6px) saturate(150%);
      border-radius:14px;padding:10px 12px;box-shadow:var(--shadow);
    }
    .sb-left{display:flex;align-items:center;gap:10px}
    .sb-actions{display:flex;gap:10px;flex-wrap:wrap}
    .sb-actions .btn{min-width:180px}
    .brand-subtle{font-weight:700;background:linear-gradient(90deg,#0ea5e9,#10b981);-webkit-background-clip:text;background-clip:text;color:transparent}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="logo">FAP</div>
        <div>
          <h2 class="brand-subtle">Assistant Re-FAP</h2>
          <div class="sub">Diagnostic pédagogique → puis options simples pour passer à l’action.</div>
        </div>
      </div>

      <div class="status"><span id="statusDot" class="dot"></span><span id="statusText">Prêt</span></div>

      <pre id="output"></pre>
      <div id="ctas" class="cta"></div>

      <form id="f" style="margin-top:16px">
        <textarea id="q" rows="3" placeholder="Décris le symptôme (ex. : Voyant moteur + perte de puissance)…"></textarea>
        <div class="row" style="margin-top:10px;align-items:center">
          <div class="col"><span id="state" class="hint"></span></div>
          <button id="send" type="submit" class="btn-accent">Envoyer</button>
        </div>
      </form>

      <div class="hint" style="margin-top:6px">
        Le texte arrive en streaming. Les questions utiles et les boutons (CTA) s’affichent ensuite.
      </div>
    </div>
  </div>

  <!-- ==== Barre d’actions permanente ==== -->
  <div class="sticky-wrap">
    <div class="stickybar">
      <div class="sb-left">
        <span class="hint">Besoin d’aide rapide ?</span>
      </div>
      <div class="sb-actions">
        <button type="button" id="stickyCallback" class="btn btn-ghost">Être rappelé</button>
        <a id="stickyBooking" href="/rdv" class="btn btn-accent">Demander un diagnostic</a>
      </div>
    </div>
  </div>

  <!-- Modal 1: Infos véhicule -->
  <div class="modal" id="modalIntake">
    <div class="box">
      <h3>Quelques infos (optionnel)</h3>
      <div class="row"><div class="col"><input id="brand"  placeholder="Marque"></div><div class="col"><input id="model" placeholder="Modèle"></div></div>
      <div class="row" style="margin-top:8px"><div class="col"><input id="engine" placeholder="Moteur (ex: 1.6 HDi)"></div><div class="col"><input id="year" placeholder="Année-modèle (ex: 2015)"></div></div>
      <div class="row" style="margin-top:8px"><div class="col"><input id="dtc" placeholder="Code erreur OBD (DTC) si connu"></div><div class="col"><input id="postal" placeholder="Code postal"></div></div>
      <div style="margin-top:8px"><textarea id="notes" rows="2" placeholder="Observations (facultatif)"></textarea></div>
      <div class="actions">
        <button type="button" id="skipIntake" class="btn-outline">Ignorer</button>
        <button type="button" id="saveIntake" class="btn-accent">Enregistrer</button>
      </div>
      <div class="hint">Ces infos nous aident à affiner le diagnostic et à te proposer un garage proche. Tu peux ignorer.</div>
    </div>
  </div>

  <!-- Modal 2: Être rappelé -->
  <div class="modal" id="modalCallback">
    <div class="box">
      <h3>Être rappelé par un conseiller</h3>
      <div class="row"><div class="col"><input id="cbName" placeholder="Nom"></div><div class="col"><input id="cbPhone" placeholder="Téléphone"></div></div>
      <div class="row" style="margin-top:8px"><div class="col"><input id="cbEmail" placeholder="Email"></div></div>
      <div class="actions">
        <button type="button" id="cancelCb" class="btn-outline">Annuler</button>
        <button type="button" id="saveCb" class="btn-accent">Envoyer</button>
      </div>
      <div class="hint">On t’appelle rapidement pour caler un rendez-vous avec un garage partenaire sérieux.</div>
    </div>
  </div>

  <script>
  const out   = document.getElementById("output");
  const state = document.getElementById("state");
  const form  = document.getElementById("f");
  const q     = document.getElementById("q");
  const btn   = document.getElementById("send");
  const ctas  = document.getElementById("ctas");
  const modalIntake = document.getElementById("modalIntake");
  const modalCallback = document.getElementById("modalCallback");
  const stickyCallback = document.getElementById("stickyCallback");
  const stickyBooking  = document.getElementById("stickyBooking");
  const statusDot  = document.getElementById("statusDot");
  const statusText = document.getElementById("statusText");

  const SID_KEY = "refap_sid";
  let sid = localStorage.getItem(SID_KEY);
  if (!sid) { sid = Math.random().toString(36).slice(2); localStorage.setItem(SID_KEY, sid); }

  function openModal(m){ m.classList.add("open"); }
  function closeModal(m){ m.classList.remove("open"); }

  let lastLead = null;

  function buildLeadContext() {
    if (!lastLead) return "";
    const parts = [];
    if (lastLead.brand)  parts.push(`marque=${lastLead.brand}`);
    if (lastLead.model)  parts.push(`modèle=${lastLead.model}`);
    if (lastLead.engine) parts.push(`moteur=${lastLead.engine}`);
    if (lastLead.year)   parts.push(`année=${lastLead.year}`);
    if (lastLead.dtc)    parts.push(`code DTC=${lastLead.dtc}`);
    if (lastLead.postal_code) parts.push(`code postal=${lastLead.postal_code}`);
    if (lastLead.notes)  parts.push(`observations=${lastLead.notes}`);
    if (!parts.length) return "";
    return `Contexte véhicule fourni par l’utilisateur : ${parts.join(", ")}. Ne redemande pas ces infos ; demande uniquement ce qui manque.`;
  }

  // Token pour éviter rendus multiples
  let currentToken = null;

  // Handlers modales attachés une fois
  let intakeNext = null;
  document.getElementById("skipIntake").addEventListener("click", () => {
    closeModal(modalIntake);
    if (typeof intakeNext === "function") intakeNext();
  });
  document.getElementById("saveIntake").addEventListener("click", async () => {
    lastLead = {
      session_id: sid,
      brand:  document.getElementById("brand").value.trim() || null,
      model:  document.getElementById("model").value.trim() || null,
      engine: document.getElementById("engine").value.trim() || null,
      year:   document.getElementById("year").value.trim() || null,
      dtc:    document.getElementById("dtc").value.trim() || null,
      notes:  document.getElementById("notes").value.trim() || null,
      postal_code: document.getElementById("postal").value.trim() || null
    };
    try {
      await fetch("/api/leads/intake", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(lastLead)
      });
    } catch {}
    closeModal(modalIntake);
    if (typeof intakeNext === "function") intakeNext();
  });

  // Barre sticky
  stickyCallback.onclick = () => openModal(modalCallback);

  document.getElementById("cancelCb").onclick = () => closeModal(modalCallback);
  document.getElementById("saveCb").onclick = async () => {
    const body = {
      session_id: sid,
      contact_name:  document.getElementById("cbName").value.trim() || null,
      contact_phone: document.getElementById("cbPhone").value.trim() || null,
      contact_email: document.getElementById("cbEmail").value.trim() || null
    };
    try {
      await fetch("/api/leads/callback", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      closeModal(modalCallback);
      alert("Merci ! On te rappelle rapidement.");
    } catch {
      alert("Désolé, l’enregistrement a échoué.");
    }
  };

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const prompt = q.value.trim();
    if (!prompt) return;

    currentToken = Math.random().toString(36).slice(2);
    const myToken = currentToken;

    out.textContent = "";
    ctas.innerHTML  = "";
    btn.disabled = true; state.textContent = "";
    statusDot.classList.add("live"); statusText.textContent = "Réponse en cours…";

    openModal(modalIntake);

    intakeNext = async () => {
      const ctx = buildLeadContext();
      const effectivePrompt = (ctx ? (ctx + "\n\n") : "") + prompt;

      try {
        await streamAnswer(effectivePrompt); // texte seul
      } catch (err) {
        out.textContent = "Erreur: " + (err?.message || err);
      } finally {
        if (myToken === currentToken) {
          btn.disabled = false;
          statusDot.classList.remove("live"); statusText.textContent = "Prêt";
        }
      }

      if (myToken !== currentToken) return;

      try {
        const r = await fetch(`/api/diagnose?prompt=${encodeURIComponent(effectivePrompt)}`);
        if (r.ok) {
          const j = await r.json();
          if (myToken !== currentToken) return;
          ctas.innerHTML = "";
          renderQuestions(j?.payload?.next_questions);
          renderCTAs(j?.payload);
        }
      } catch {}
    };
  });

  // SSE robuste : watchdog + fallback non-stream (texte seul)
  async function streamAnswer(prompt) {
    const url = `/api/diagnose/stream?prompt=${encodeURIComponent(prompt)}`;
    let received = false;

    const watchdogMs = 8000;
    let watchdog;
    const arm = (resolve, reject) => {
      clearTimeout(watchdog);
      watchdog = setTimeout(async () => {
        if (!received) {
          try {
            const r = await fetch(`/api/diagnose?prompt=${encodeURIComponent(prompt)}`);
            const j = await r.json().catch(() => ({}));
            out.textContent = j?.text || out.textContent || "";
            resolve();
          } catch {
            reject(new Error("fallback_failed"));
          }
        }
      }, watchdogMs);
    };

    await new Promise((resolve, reject) => {
      const es = new EventSource(url);
      arm(resolve, reject);

      es.onmessage = (e) => {
        try {
          const o = JSON.parse(e.data);
          if (o.error) { es.close(); clearTimeout(watchdog); reject(new Error(o.error)); return; }
          if (o.delta) { out.textContent += o.delta; received = true; }
          if (o.done)  { es.close(); clearTimeout(watchdog); resolve(); return; }
        } catch {
          out.textContent += e.data;
          if (e.data && e.data.length) received = true;
        }
        arm(resolve, reject);
      };

      es.onerror = async () => {
        es.close();
        clearTimeout(watchdog);
        if (received) { resolve(); return; }
        try {
          const r = await fetch(`/api/diagnose?prompt=${encodeURIComponent(prompt)}`);
          const j = await r.json().catch(() => ({}));
          out.textContent = j?.text || out.textContent || "";
          resolve();
        } catch {
          reject(new Error("sse_error_and_fallback_failed"));
        }
      };
    });
  }

  function renderQuestions(nextQuestions){
    if (!Array.isArray(nextQuestions)) return;
    const seen = new Set();
    const cleaned = nextQuestions
      .map(s => String(s || "").trim())
      .filter(Boolean)
      .filter(q => {
        const key = q.toLowerCase().replace(/\s+/g, " ");
        if (seen.has(key)) return false;
        seen.add(key); return true;
      });
    if (!cleaned.length) return;

    const block = document.createElement("div");
    const title = document.createElement("div");
    title.className = "qtitle";
    title.textContent = "Voici quelques questions pour affiner le diagnostic et t’aider à trouver la bonne solution :";
    block.appendChild(title);

    const ul = document.createElement("ul");
    ul.className = "questions";
    cleaned.forEach(q => {
      const li = document.createElement("li"); li.className = "ask"; li.textContent = q;
      ul.appendChild(li);
    });
    block.appendChild(ul);

    ctas.appendChild(block);
  }

  function renderCTAs(payload){
    if (!payload) return;
    const buttons = [];
    const keys = new Set();
    const pushBtn = (type, label, url, primary=false) => {
      label = (label || "").trim();
      const key = `${(type||"").toLowerCase()}|${label.toLowerCase()}`;
      if (!label || keys.has(key)) return;
      keys.add(key);
      const el = document.createElement(url ? "a" : "button");
      el.textContent = label;
      el.className = primary ? "btn btn-accent" : "btn btn-outline";
      if (url) { el.href = url; }
      const rank = /rdv|diagnostic/i.test(label) ? 0 : (/rappel/i.test(label) ? 1 : 2);
      buttons.push({ el, rank });
    };

    if (payload?.cta?.show && Array.isArray(payload.cta.items)) {
      payload.cta.items.forEach(it => pushBtn(it.type, it.label, it.url, false));
    }

    const hasCallback = Array.isArray(payload?.cta?.items) &&
      payload.cta.items.some(it => (it.type||"").toLowerCase()==="callback" || /rappel/i.test(it?.label||""));
    if (!hasCallback) {
      const key = "callback|être rappelé";
      if (!keys.has(key)) {
        keys.add(key);
        const b = document.createElement("button");
        b.textContent = "Être rappelé";
        b.className = "btn btn-ghost";
        b.onclick = () => openModal(modalCallback);
        buttons.push({ el:b, rank:1 });
      }
    }

    buttons.sort((a,b)=>a.rank-b.rank);
    buttons.slice(0,2).forEach(({el}) => ctas.appendChild(el));
  }
  </script>
</body>
</html>
