<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Re-FAP assistant</title>
  <style>
    :root{--fg:#111;--muted:#6b7280;--border:#e5e7eb;--bg:#fafafa;--brand:#111;--accent:#0b5}
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Roboto,sans-serif;margin:24px;background:var(--bg);color:var(--fg)}
    .wrap{max-width:980px;margin:0 auto}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:20px}
    h2{margin:0 0 6px 0}
    textarea,input{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px;font-size:16px}
    button{padding:10px 16px;border:1px solid var(--brand);border-radius:10px;background:var(--brand);color:#fff;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    pre{white-space:pre-wrap;word-wrap:break-word;margin:8px 0 0}
    .row{display:flex;gap:10px}
    .col{flex:1}
    .hint{color:var(--muted);font-size:12px}
    .cta{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .btn-outline{background:#fff;color:var(--fg)}
    /* Questions en valeur */
    .questions{margin:10px 0 0 0;padding-left:18px}
    .questions li{margin:4px 0}
    .ask{color:var(--accent);font-weight:700}
    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:16px;z-index:20}
    .modal.open{display:flex}
    .modal .box{background:#fff;border-radius:12px;padding:20px;max-width:560px;width:100%;border:1px solid var(--border)}
    .modal h3{margin-top:0}
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Re-FAP assistant</h2>
      <div id="log" class="hint"></div>
      <pre id="output"></pre>
      <div id="ctas" class="cta"></div>

      <form id="f" style="margin-top:16px">
        <textarea id="q" rows="3" placeholder="Décris le symptôme..."></textarea>
        <div class="row" style="margin-top:10px;align-items:center">
          <div class="col"><span id="state" class="hint"></span></div>
          <button id="send" type="submit">Envoyer</button>
        </div>
      </form>
      <div class="hint" style="margin-top:6px">
        Le texte arrive en streaming. Les questions utiles et les boutons (CTA) s’affichent ensuite.
      </div>
    </div>
  </div>

  <!-- Modal 1: Infos véhicule -->
  <div class="modal" id="modalIntake">
    <div class="box">
      <h3>Quelques infos (optionnel)</h3>
      <div class="row"><div class="col"><input id="brand"  placeholder="Marque"></div><div class="col"><input id="model" placeholder="Modèle"></div></div>
      <div class="row" style="margin-top:8px"><div class="col"><input id="engine" placeholder="Moteur (ex: 1.6 HDi)"></div><div class="col"><input id="year" placeholder="Année-modèle (ex: 2015)"></div></div>
      <div class="row" style="margin-top:8px"><div class="col"><input id="dtc" placeholder="Code erreur OBD (DTC) si connu"></div><div class="col"><input id="postal" placeholder="Code postal"></div></div>
      <div style="margin-top:8px"><textarea id="notes" rows="2" placeholder="Observations (facultatif)"></textarea></div>
      <div class="actions">
        <button type="button" id="skipIntake" class="btn-outline">Ignorer</button>
        <button type="button" id="saveIntake">Enregistrer</button>
      </div>
      <div class="hint">Ces infos nous aident à affiner le diagnostic et à te proposer un garage proche. Tu peux ignorer.</div>
    </div>
  </div>

  <!-- Modal 2: Être rappelé -->
  <div class="modal" id="modalCallback">
    <div class="box">
      <h3>Être rappelé par un conseiller</h3>
      <div class="row"><div class="col"><input id="cbName" placeholder="Nom"></div><div class="col"><input id="cbPhone" placeholder="Téléphone"></div></div>
      <div class="row" style="margin-top:8px"><div class="col"><input id="cbEmail" placeholder="Email"></div></div>
      <div class="actions">
        <button type="button" id="cancelCb" class="btn-outline">Annuler</button>
        <button type="button" id="saveCb">Envoyer</button>
      </div>
      <div class="hint">On t’appelle rapidement pour caler un rendez-vous avec un garage partenaire sérieux.</div>
    </div>
  </div>

  <script>
  const out   = document.getElementById("output");
  const log   = document.getElementById("log");
  const state = document.getElementById("state");
  const form  = document.getElementById("f");
  const q     = document.getElementById("q");
  const btn   = document.getElementById("send");
  const ctas  = document.getElementById("ctas");

  const modalIntake = document.getElementById("modalIntake");
  const modalCallback = document.getElementById("modalCallback");

  const SID_KEY = "refap_sid";
  let sid = localStorage.getItem(SID_KEY);
  if (!sid) { sid = Math.random().toString(36).slice(2); localStorage.setItem(SID_KEY, sid); }

  function openModal(m){ m.classList.add("open"); }
  function closeModal(m){ m.classList.remove("open"); }

  let lastLead = null;

  function buildLeadContext() {
    if (!lastLead) return "";
    const parts = [];
    if (lastLead.brand)  parts.push(`marque=${lastLead.brand}`);
    if (lastLead.model)  parts.push(`modèle=${lastLead.model}`);
    if (lastLead.engine) parts.push(`moteur=${lastLead.engine}`);
    if (lastLead.year)   parts.push(`année=${lastLead.year}`);
    if (lastLead.dtc)    parts.push(`code DTC=${lastLead.dtc}`);
    if (lastLead.postal_code) parts.push(`code postal=${lastLead.postal_code}`);
    if (lastLead.notes)  parts.push(`observations=${lastLead.notes}`);
    if (!parts.length) return "";
    return `Contexte véhicule fourni par l’utilisateur : ${parts.join(", ")}. Ne redemande pas ces infos ; demande uniquement ce qui manque.`;
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const prompt = q.value.trim();
    if (!prompt) return;
    out.textContent = "";
    ctas.innerHTML  = "";
    log.textContent = "Toi: " + prompt;
    btn.disabled = true; state.textContent = "…";

    openModal(modalIntake);

    const doAfterIntake = async () => {
      const ctx = buildLeadContext();
      const effectivePrompt = (ctx ? (ctx + "\n\n") : "") + prompt;

      try {
        await streamAnswer(effectivePrompt);   // ne rend QUE le texte
      } catch (err) {
        out.textContent = "Erreur: " + (err?.message || err);
      } finally {
        btn.disabled = false; state.textContent = "";
      }

      // une seule récupération du payload ici → pas de doublons
      try {
        const r = await fetch(`/api/diagnose?prompt=${encodeURIComponent(effectivePrompt)}`);
        if (r.ok) {
          const j = await r.json();
          renderQuestions(j?.payload?.next_questions);
          renderCTAs(j?.payload);
        }
      } catch {}
    };

    document.getElementById("skipIntake").onclick = () => { closeModal(modalIntake); doAfterIntake(); };
    document.getElementById("saveIntake").onclick = async () => {
      lastLead = {
        session_id: sid,
        brand:  document.getElementById("brand").value.trim() || null,
        model:  document.getElementById("model").value.trim() || null,
        engine: document.getElementById("engine").value.trim() || null,
        year:   document.getElementById("year").value.trim() || null,
        dtc:    document.getElementById("dtc").value.trim() || null,
        notes:  document.getElementById("notes").value.trim() || null,
        postal_code: document.getElementById("postal").value.trim() || null
      };
      try {
        await fetch("/api/leads/intake", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(lastLead)
        });
      } catch {}
      closeModal(modalIntake);
      doAfterIntake();
    };
  });

  // --- SSE robuste : watchdog + fallback non-stream (texte seul)
  async function streamAnswer(prompt) {
    const url = `/api/diagnose/stream?prompt=${encodeURIComponent(prompt)}`;
    let received = false;

    const watchdogMs = 8000;
    let watchdog;
    const arm = (resolve, reject) => {
      clearTimeout(watchdog);
      watchdog = setTimeout(async () => {
        if (!received) {
          try {
            const r = await fetch(`/api/diagnose?prompt=${encodeURIComponent(prompt)}`);
            const j = await r.json().catch(() => ({}));
            out.textContent = j?.text || out.textContent || "";
            resolve(); // CTA/questions seront rendus plus tard par doAfterIntake()
          } catch {
            reject(new Error("fallback_failed"));
          }
        }
      }, watchdogMs);
    };

    await new Promise((resolve, reject) => {
      const es = new EventSource(url);
      arm(resolve, reject);

      es.onmessage = (e) => {
        try {
          const o = JSON.parse(e.data);
          if (o.error) { es.close(); clearTimeout(watchdog); reject(new Error(o.error)); return; }
          if (o.delta) { out.textContent += o.delta; received = true; }
          if (o.done)  { es.close(); clearTimeout(watchdog); resolve(); return; }
        } catch {
          out.textContent += e.data;
          if (e.data && e.data.length) received = true;
        }
        arm(resolve, reject);
      };

      es.onerror = async () => {
        es.close();
        clearTimeout(watchdog);
        if (received) { resolve(); return; }
        try {
          const r = await fetch(`/api/diagnose?prompt=${encodeURIComponent(prompt)}`);
          const j = await r.json().catch(() => ({}));
          out.textContent = j?.text || out.textContent || "";
          resolve(); // CTA/questions rendus ensuite
        } catch {
          reject(new Error("sse_error_and_fallback_failed"));
        }
      };
    });
  }

  function renderQuestions(nextQuestions){
    if (!Array.isArray(nextQuestions)) return;
    // dédup insensible à la casse
    const seen = new Set();
    const cleaned = nextQuestions
      .map(s => String(s || "").trim())
      .filter(Boolean)
      .filter(q => {
        const key = q.toLowerCase().replace(/\s+/g, " ");
        if (seen.has(key)) return false;
        seen.add(key); return true;
      });
    if (!cleaned.length) return;

    const ul = document.createElement("ul");
    ul.className = "questions";
    cleaned.forEach(q => {
      const li = document.createElement("li"); li.className = "ask"; li.textContent = q;
      ul.appendChild(li);
    });
    ctas.appendChild(ul);
  }

  function renderCTAs(payload){
    if (!payload) return;

    // helper dédup
    const buttons = [];
    const keys = new Set();
    const pushBtn = (type, label, url, primary=false) => {
      label = (label || "").trim();
      const key = `${(type||"").toLowerCase()}|${label.toLowerCase()}`;
      if (!label || keys.has(key)) return;
      keys.add(key);

      const b = document.createElement("button");
      b.textContent = label;
      b.className = primary ? "" : "btn-outline";
      if (primary) { b.style.background = "var(--accent)"; b.style.borderColor = "var(--accent)"; }
      if (url) b.onclick = () => { window.location.href = url; };
      buttons.push({ btn:b, rank: label.toLowerCase().includes("rdv") ? 0 : (label.toLowerCase().includes("rappel") ? 1 : 2) });
    };

    // 1) payload
    if (payload?.cta?.show && Array.isArray(payload.cta.items)) {
      payload.cta.items.forEach(it => pushBtn(it.type, it.label, it.url, false));
    }

    // 2) bouton "Être rappelé" par défaut UNIQUEMENT s'il n'existe pas déjà
    const hasCallback = Array.isArray(payload?.cta?.items) && payload.cta.items.some(it => (it.type||"").toLowerCase()==="callback" || /rappel/i.test(it?.label||""));
    if (!hasCallback) {
      const b = document.createElement("button");
      b.textContent = "Être rappelé";
      b.style.background = "var(--accent)";
      b.style.borderColor = "var(--accent)";
      b.onclick = () => openModal(modalCallback);
      const key = "callback|être rappelé";
      if (!keys.has(key)) {
        keys.add(key);
        buttons.push({ btn:b, rank: 1 });
      }
    }

    // 3) tri & limite (2)
    buttons.sort((a,b)=>a.rank-b.rank);
    buttons.slice(0,2).forEach(({btn}) => ctas.appendChild(btn));

    // handlers callback modal
    document.getElementById("cancelCb").onclick = () => closeModal(modalCallback);
    document.getElementById("saveCb").onclick = async () => {
      const body = {
        session_id: sid,
        contact_name:  document.getElementById("cbName").value.trim() || null,
        contact_phone: document.getElementById("cbPhone").value.trim() || null,
        contact_email: document.getElementById("cbEmail").value.trim() || null
      };
      try {
        await fetch("/api/leads/callback", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        closeModal(modalCallback);
        alert("Merci ! On te rappelle rapidement.");
      } catch {
        alert("Désolé, l’enregistrement a échoué.");
      }
    };
  }
  </script>
</body>
</html>
